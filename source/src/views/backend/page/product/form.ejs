<% include ./../../helper/select-box-default.ejs %>
<% include ./../../helper/image.ejs %>

<% 
	const collection = 'product'
	const linkPrefix = systemConfig.prefixAdmin + `/${collection}/`
    const folderUpload = 'uploads/products/'
%>

    <div class="card card-info card-outline">
        <form action= <%= linkPrefix + 'form'%> method="POST" id ="form-category" enctype="multipart/form-data" >
            <div class="card-body">
                <h1>
                    <%= pageTitle%>
                </h1>
                <div class="form-group row">
                    <label for="name" class="col-sm-2 col-form-label text-sm-right required">Name</label>
                    <div class="col-xs-12 col-sm-8">
                        <input type="text" id="name" name="name" class="form-control form-control-sm" value="<%= items.name%>" placeholder="VD: Thể Thao">
                        <span class="form-message" style = "color: red;"></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="ordering" class="col-sm-2 col-form-label text-sm-right required">Ordering</label>
                    <div class="col-xs-12 col-sm-8">
                        <input type="number" id="ordering" name="ordering" class="form-control form-control-sm" value="<%= items.ordering%>" placeholder="VD: 1">
                        <span class="form-message" style = "color: red;"></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="quantity" class="col-sm-2 col-form-label text-sm-right required">Quantity</label>
                    <div class="col-xs-12 col-sm-8">
                        <input type="number" id="quantity" name="quantity" class="form-control form-control-sm" value="<%= items.quantity%>" placeholder="VD: 1">
                        <span class="form-message" style = "color: red;"></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="price" class="col-sm-2 col-form-label text-sm-right required">Price</label>
                    <div class="col-xs-12 col-sm-8">
                        <input type="number" id="price" name="price" class="form-control form-control-sm" value="<%= items.price%>" placeholder="VD: 1">
                        <span class="form-message" style = "color: red;"></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="discount" class="col-sm-2 col-form-label text-sm-right required">Percentage Discount</label>
                    <div class="col-xs-12 col-sm-8">
                        <input onkeyup="discountProduct(this)" type="number" id="discount" name="discount" class="form-control form-control-sm" value="<%= items.discount%>" placeholder="VD: 1">
                        <span class="form-message" style = "color: red;"></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="status" class="col-sm-2 col-form-label text-sm-right">Status</label>
                    <div class="col-xs-12 col-sm-8">
                        <select id="status" name="status" class="custom-select custom-select-sm" >
                            <option value="novalue">Choose Status</option>
                            <option value="active" <%=(items.status=="active" ? 'selected="selected"' : '' ) %> >
                                Active</option>
                            <option value="inactive" <%=(items.status=="inactive" ? 'selected="selected"' : '' ) %> >
                                Inactive</option>
                        </select>
                        <span class="form-message" style = "color: red;"></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="category" class="col-sm-2 col-form-label text-sm-right">Category</label>
                    <div class="col-xs-12 col-sm-8">
                        <%- selectBoxDefaultHelper('category', categoryItems, items.id_category) %>
                        <span class="form-message" style = "color: red;"></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="category" class="col-sm-2 col-form-label text-sm-right">Group Category</label>
                    <div class="col-xs-12 col-sm-8">
                        <%- selectBoxDefaultHelper('group', groupItems, items.id_group_category) %>
                        <span class="form-message" style = "color: red;"></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="Check" class="col-sm-2 col-form-label text-sm-right required">Lựa chọn:</label>
                    <% if (items.id !== undefined && items.id !== '') { %>
                        <div style="padding: 1%;">
                            <input type="checkbox" id="vehicle1" name="arrCheck" value="show_home" <%=(items.arrCheck.includes('show_home')   ? 'checked="checked"' : '' ) %> >
                            <label for="vehicle1"> Show_home </label><br>
                        </div>
                        <div style="padding: 1%;">
                            <input type="checkbox" id="vehicle2" name="arrCheck" value="special" <%=(items.arrCheck.includes('special')   ? 'checked="checked"' : '' ) %> >
                            <label for="vehicle2"> Special </label><br>
                        </div>
                        <div style="padding: 1%;">
                            <input type="checkbox" id="vehicle3" name="arrCheck" value="discount" <%=(items.arrCheck.includes('discount')   ? 'checked="checked"' : '' ) %> >
                            <label for="vehicle3"> Discount </label><br>
                        </div>
                    <% } else { %>
                        <div style="padding: 1%;">
                            <input type="checkbox" id="vehicle1" name="arrCheck" value="show_home" >
                            <label for="vehicle1"> Show_home </label><br>
                        </div>
                        <div style="padding: 1%;">
                            <input type="checkbox" id="vehicle2" name="arrCheck" value="special" >
                            <label for="vehicle2"> Special </label><br>
                        </div>
                        <div style="padding: 1%;">
                            <input type="checkbox" id="vehicle3" name="arrCheck" value="discount" >
                            <label for="vehicle3"> Discount </label><br>
                        </div>
                    <% } %>
                </div>
                <div class="form-group row">
                    <label for="content_ck" class="col-sm-2 col-form-label text-sm-right required">Content</label>
                    <textarea name="content" rows="2" id="content"><%= items.content%></textarea>
                    <span class="form-message" style = "color: red;"></span>
                </div>

                <input type="file" id="avatar" name="avatar" class="form-control form-control-sm" value="" style="padding-bottom: 2rem" multiple>
                <input type="text" id="arrAvatar" name="arrAvatar" class="form-control form-control-sm" value="<%= items.avatar%>" hidden>
                <div class="dropzone" id="upload-avatar"></div>

                <input type="hidden" name="id" value="<%= items.id%>" >
                <input type="hidden" name="remove_image_old" value="" >
            </div>
            <div class="card-footer">
                <div class="col-12 col-sm-8 offset-sm-2">
                    <button type="submit" class="btn btn-sm btn-success mr-1">
                        Submit</button>
                    <a href= <%= linkPrefix%> class="btn btn-sm btn-danger mr-1">
                        Cancel</a>
                </div>
            </div>
        </form>

<script>
    CKEDITOR.replace('content');
</script>
<!--Custom Validator-->
<script src="/backend/js/customValidator.js"></script> 
<script>
    Validator({
        form: '#form-category',
        errorSelector: '.form-message',
        rules: [
            Validator.isRequired('#name'),
            Validator.minLength('#name', 6, 'Name phải có tối thiểu 6 ký tự'),
            Validator.isRequired('#ordering'),
            Validator.minMaxInt('#ordering', 1, 100, 'Ordering phải số nguyên và có giá trị từ 1 đến 100'),
            Validator.isSelected('#status', 'Vui lòng chọn trường status'),
            Validator.isSelected('#category', 'Vui lòng chọn trường category'),
        ],
    });
</script>

<script type="text/javascript">
    window.onload = function() {
        Dropzone.autoDiscover = false;
        let myDropzone = new Dropzone("div#upload-avatar", {
            url: "/admin/product/upload",
            autoProcessQueue: false,
            addRemoveLinks: true,
            acceptedFiles: ".jpeg,.jpg,.png,.gif,.webp",
            uploadMultiple: true,
            parallelUploads: 10,
            init: function(file) {
                var arrFile = []
                const dataTransfer = new DataTransfer();
                var arrRemove = []
                
                this.on("addedfile", function(file){
                    if(file.size >= 100){
                        const fileInput = document.querySelector('input[type="file"]');
                        var myFile = file
                        dataTransfer.items.add(myFile);
                        fileInput.files = dataTransfer.files;
                        arrFile.push(file)
                    }
                })

                this.on("removedfile", function(file){
                    if(file.size >= 100){
                        const fileInput = document.querySelector('input[type="file"]');
                        const arr = [...arrFile];

                        arr.forEach((value, index) =>{
                            if(value.upload.uuid === file.upload.uuid){
                                dataTransfer.items.remove(index);
                                arrFile.splice(index,1);
                            }
                        })
                        fileInput.files = dataTransfer.files;
                    } else {
                        arrRemove.push(file.upload.filename)
                        $('input[name="remove_image_old"]').val(arrRemove)
                    }
                })
            },
        });

        var fileVal = document.getElementById("arrAvatar");
        if (fileVal.value !== ""){
            let arrAvatar = fileVal.value.split(',');

            arrAvatar.forEach((value) => {
                var path = `uploads/products/${value}`
                var file = new File([Blob], `${value}`, {type:"image/webp", lastModified:new Date().getTime()}, 'utf-8');
                file['status'] = "queued";
                file['status'] = "queued";
                file['previewElement'] = "div.dz-preview.dz-image-preview";
                file['previewTemplate'] = "div.dz-preview.dz-image-preview";
                file['_removeLink'] = "a.dz-remove";
                file['webkitRelativePath'] = "";
                file['width'] = 1280;
                file['height'] = 1280;
                file['accepted'] = true;
                file['size'] = 158554;
                file['dataURL'] = path;
                file['upload'] = {
                    bytesSent: 0 ,
                    filename: `${value}` ,
                    progress: 0 ,
                    total: 158554 ,
                    uuid: `${value}` ,
                };

            myDropzone.emit("addedfile", file);
            myDropzone.emit("thumbnail", file, path);
            myDropzone.emit("complete", file);

            // myDropzone.files.push(file);
            })
        }
    }
</script>



